<a
  href="{href}"
  target="{target}"
  class="{computedClass}"
  aria-current="{computedAriaCurrent}"
  on:click="{handleClick}"
>
  <slot></slot>
</a>

<script>
import { createLocation } from 'history';
import { getHistory, isModifiedEvent, matchPath } from './index.js';

export let to = '#';
export let replace = false;
export let target = '';
export let exact = false;
export let strict = false;
export let activeClassName = 'active';
export let className = '';
export let ariaCurrent = true;

const history = getHistory();
let pathname = history.location.pathname;
let href;
let escapedPath;
let isActive;
let computedClass;
let computedAriaCurrent;

$: href = history.createHref(typeof to === 'string' ? createLocation(to, null, null, history.location) : to);
$: {
  const path = typeof to === 'object' ? to.pathname : to;
  escapedPath = path.replace(/([.+*?=^!:${}()[\]|/\\])/g, '\\$1');
}
$: isActive = matchPath(pathname, { escapedPath, exact, strict });
$: {
  const classes = [];

  if (className !== '') {
    classes.push(className);
  }
  if (isActive) {
    classes.push(activeClassName);
  }

  computedClass = classes.join(' ');
}
$: computedAriaCurrent = (isActive && ariaCurrent) || 'false';


function handleClick(event) {
  // Ignore everything but left clicks, let browser handle
  // "target=_blank" etc., ignore clicks with modifier keys
  if (event.button !== 0 || target !== '' || isModifiedEvent(event)) {
    return;
  }

  event.preventDefault();

  if (replace) {
    history.replace(to);
  } else {
    history.push(to);
  }
}

const unlisten = history.listen(location => {
  pathname = location.pathname;
});

onDestroy(unlisten);
</script>
